services:
  session-server:
    build:
      context: ../../server
      dockerfile: Dockerfile
    container_name: owp-session-server
    ports:
      - "${SESSION_SERVER_PORT:-3000}:3000"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 64M
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

  jellyfin-dev:
    image: jellyfin/jellyfin:10.11.3
    container_name: jellyfin-dev
    depends_on:
      - session-server
    ports:
      - "${JELLYFIN_PORT:-8096}:8096"
    volumes:
      - ./config:/config
      - jellyfin-cache:/cache
      - ${MEDIA_DIR:-${HOME}/Videos/Movies}:/media/Movies:ro
      - ../../clients/jellyfin-web:/jellyfin/jellyfin-web/plugins/openwatchparty:ro
      - ../../plugins/jellyfin/OpenWatchParty/dist:/config/plugins/OpenWatchParty
    restart: unless-stopped
    entrypoint:
      - /bin/bash
      - -c
      - |
        set -e
        # Backup original index.html if not exists
        if [ ! -f /jellyfin/jellyfin-web/index.html.bak ]; then
          cp /jellyfin/jellyfin-web/index.html /jellyfin/jellyfin-web/index.html.bak
        fi

        # Restore original to ensure clean state
        cp /jellyfin/jellyfin-web/index.html.bak /jellyfin/jellyfin-web/index.html

        # Remove previous injections if any
        sed -i 's|<script src="/OpenWatchParty/ClientScript[^"]*"></script>||g' /jellyfin/jellyfin-web/index.html
        sed -i 's|<script src="/web/plugins/openwatchparty/plugin.js[^"]*"></script>||g' /jellyfin/jellyfin-web/index.html

        # Inject new version with cache buster
        TS=$$(date +%s)
        sed -i "s|</body>|<script src=\"/web/plugins/openwatchparty/plugin.js?v=$$TS\"></script></body>|" /jellyfin/jellyfin-web/index.html

        echo "Restored and injected index.html with v=$$TS"

        /jellyfin/jellyfin

  plugin-builder:
    image: mcr.microsoft.com/dotnet/sdk:9.0
    working_dir: /src
    network_mode: host
    user: "${UID:-1000}:${GID:-1000}"
    profiles:
      - tools
    volumes:
      - ../../plugins/jellyfin/OpenWatchParty:/src
    environment:
      - HOME=/tmp
      - DOTNET_CLI_HOME=/tmp/.dotnet
    command: dotnet publish -c Release -o /src/dist OpenWatchPartyPlugin.csproj

volumes:
  jellyfin-cache:
