services:
  session-server:
    build: ../../session-server-rust
    ports:
      - "3001:3000"

  jellyfin-dev:
    image: jellyfin/jellyfin:10.11.3
    container_name: jellyfin-dev
    ports:
      - "8096:8096"
    volumes:
      - ./config:/config
      - jellyfin-cache:/cache
      - ~/Videos/Movies/:/media/Movies:ro
      - ../../clients/web-plugin:/jellyfin/jellyfin-web/plugins/opensyncparty:ro
      - ../../plugins/jellyfin/OpenSyncParty/dist:/config/plugins/OpenSyncParty
    entrypoint:
      - /bin/bash
      - -c
      - |
        # Backup original index.html if not exists
        if [ ! -f /jellyfin/jellyfin-web/index.html.bak ]; then
          cp /jellyfin/jellyfin-web/index.html /jellyfin/jellyfin-web/index.html.bak
        fi
        
        # Restore original to ensure clean state
        cp /jellyfin/jellyfin-web/index.html.bak /jellyfin/jellyfin-web/index.html
        
        # Inject new version with cache buster
        TS=$$(date +%s)
        sed -i "s|</body>|<script src=\"/OpenSyncParty/ClientScript?v=$$TS\"></script></body>|" /jellyfin/jellyfin-web/index.html
        
        echo "Restored and injected index.html with v=$$TS"
        
        /jellyfin/jellyfin

  plugin-builder:
    image: mcr.microsoft.com/dotnet/sdk:9.0
    working_dir: /src
    network_mode: host
    volumes:
      - ../../plugins/jellyfin/OpenSyncParty:/src
      - ../../plugins/jellyfin/OpenSyncParty/dist:/out
    command: dotnet publish -c Release -o /out OpenSyncPartyPlugin.csproj /p:UseLocalJellyfinRefs=true

volumes:
  jellyfin-cache:
