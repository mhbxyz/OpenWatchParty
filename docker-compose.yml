version: "3.8"
services:
  session-server:
    image: python:3.11-slim
    working_dir: /workspace
    volumes:
      - ./:/workspace
    command: bash -lc "pip install uv && uv sync --group server && .venv/bin/python session-server/app.py"
    ports:
      - "8999:8999"
    environment:
      - JWT_SECRET=${JWT_SECRET:-}
      - JWT_AUDIENCE=${JWT_AUDIENCE:-}
      - JWT_ISSUER=${JWT_ISSUER:-}
      - INVITE_TTL_SECONDS=${INVITE_TTL_SECONDS:-3600}
      - HOST_ROLES=${HOST_ROLES:-}
      - INVITE_ROLES=${INVITE_ROLES:-}
  web-demo:
    image: python:3.11-slim
    working_dir: /workspace
    volumes:
      - ./:/workspace
    command: python -m http.server 8000 --directory clients/web
    ports:
      - "8000:8000"
  protocol-harness:
    image: python:3.11-slim
    working_dir: /workspace
    volumes:
      - ./:/workspace
    command: bash -lc "pip install uv && uv sync --group tests && .venv/bin/python tests/protocol_harness.py --ws ws://session-server:8999/ws"
    depends_on:
      - session-server
    environment:
      - JWT_SECRET=${JWT_SECRET:-}
